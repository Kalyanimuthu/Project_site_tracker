{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container">

    <h2 class="mb-0">{{ site.site_name }}</h2>
    <p class="text-muted">{{ site.location }}</p>

    <!-- ---------------- DATE FILTER ---------------- -->
    <form class="row g-3 mb-3" onsubmit="openEntryModal(event)">
        <div class="col-md-3">
            <label>From Date</label>
            <input type="date" id="from_date" class="form-control">
        </div>

        <div class="col-md-3">
            <label>To Date</label>
            <input type="date" id="to_date" class="form-control">
        </div>

        <div class="col-md-3 align-self-end">
            <button class="btn btn-dark w-100">View Entries</button>
        </div>
    </form>

    <!-- Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Entry Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body" id="modalBody">Loading...</div>

        </div>
      </div>
    </div>

    <hr>

    <!-- ---------------- SECTIONS TABLE ---------------- -->
    <h4 class="mt-4">ðŸ“Œ Sections</h4>

    <form method="POST" action="{% url 'update_sections' site.id %}">
        {% csrf_token %}
        <table class="table table-bordered bg-white mt-3">
            <thead class="table-light">
                <tr>
                    <th>Section</th>
                    <th>Labour Count</th>
                    <th>Material Count</th>
                    <th>Payment</th>
                </tr>
            </thead>

            <tbody>
                {% for sec in sections %}
                <tr>
                    <td>
    <a href="#" onclick="filterBySection('{{ sec.section_name }}')" 
       class="text-primary fw-bold text-decoration-none">
        {{ sec.section_name|title }}
    </a>
</td>


                    {% if sec.section_name == "civil" %}
                        <td>-</td>
                        <td>-</td>
                        <td class="fw-bold text-primary">â‚¹ {{ civil_team_total }}</td>
                    {% else %}
                        <td><input type="number" name="labour_{{ sec.id }}" value="{{ sec.labour_count }}" class="form-control"></td>
                        <td><input type="number" name="material_{{ sec.id }}" value="{{ sec.material_count }}" class="form-control"></td>
                        <td><input type="number" step="0.01" name="payment_{{ sec.id }}" value="{{ sec.payment }}" class="form-control"></td>
                    {% endif %}
                </tr>
                {% endfor %}
                
                <tr class="table-success fw-bold">
                    <td>Total</td>
                    <td>{{ section_labour_total }}</td>
                    <td>{{ section_material_total }}</td>
                    <td>â‚¹ {{ section_payment_total }}</td>
                </tr>
            </tbody>
        </table>

        <button class="btn btn-primary mt-2">ðŸ’¾ Save Section Updates</button>
    </form>

    <hr>

    <!-- ---------------- CIVIL TEAMS ---------------- -->
    <h4 class="mt-4">ðŸ‘· Civil Teams Payment Summary</h4>

    <form method="POST" action="{% url 'update_civil_team' site.id %}">
        {% csrf_token %}

        <table class="table table-bordered bg-white mt-3">
            <thead class="table-light">
                <tr>
                    <th>Team Name</th>
                    <th>Mason Payment</th>
                    <th>Helper Payment</th>
                    <th>Total</th>
                </tr>
            </thead>

            <tbody>
                {% for team in civil_teams %}
                <tr>
                    <td>{{ team.team_name }}</td>
                    <td><input type="number" step="0.01" name="mason_payment_{{ team.id }}" value="{{ team.mason_payment }}" class="form-control"></td>
                    <td><input type="number" step="0.01" name="helper_payment_{{ team.id }}" value="{{ team.helper_payment }}" class="form-control"></td>
                    <td class="fw-bold">â‚¹ {{ team.total_payment }}</td>
                </tr>
                {% endfor %}

                <tr class="table-success fw-bold">
                    <td colspan="3" class="text-end">TOTAL</td>
                    <td>â‚¹ {{ civil_team_total }}</td>
                </tr>
            </tbody>
        </table>

        <button class="btn btn-success mt-3">ðŸ’¾ Update Payments</button>
    </form>

</div>

<input type="hidden" id="siteId" value="{{ site.id }}">
<div class="modal fade" id="sectionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="sectionModalTitle"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="sectionModalBody">Loading...</div>

    </div>
  </div>
</div>

<!-- Correct static script load -->
<script src="{% static 'js/script.js' %}"></script>

{% endblock %}

